<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bedtime Routine Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6366f1">
</head>
<body>
    <div id="root"></div>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/recharts@2.5.0/dist/Recharts.js"></script>
    
    <script>
        const { useState, useEffect } = React;
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = Recharts;
        
        // Simple SVG icon components
        const Icon = ({ path, ...props }) => 
            React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round', ...props },
                React.createElement('path', { d: path })
            );

        function BedtimeTracker() {
          const [isRunning, setIsRunning] = useState(false);
          const [startTime, setStartTime] = useState(null);
          const [elapsedTime, setElapsedTime] = useState(0);
          const [editMode, setEditMode] = useState(false);
          
          const [kids, setKids] = useState(['Emma', 'Liam']);
          const [tasks, setTasks] = useState(['Brush Teeth', 'Pajamas', 'Story Time', 'Lights Out']);
          const [completions, setCompletions] = useState({});
          const [showSummary, setShowSummary] = useState(false);
          
          const [dailyRecords, setDailyRecords] = useState([]);
          const [points, setPoints] = useState({});
          const [showHistory, setShowHistory] = useState(false);
          const [showSpendPoints, setShowSpendPoints] = useState(false);
          const [selectedKid, setSelectedKid] = useState('');
          const [pointsToSpend, setPointsToSpend] = useState('');
          
          const [newKidName, setNewKidName] = useState('');
          const [newTaskName, setNewTaskName] = useState('');
          const [editingKid, setEditingKid] = useState(null);
          const [editingTask, setEditingTask] = useState(null);

          const colors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899'];

          useEffect(() => {
            let interval;
            if (isRunning) {
              interval = setInterval(() => {
                setElapsedTime(Date.now() - startTime);
              }, 10);
            }
            return () => clearInterval(interval);
          }, [isRunning, startTime]);

          const formatTime = (ms) => {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            const centiseconds = Math.floor((ms % 1000) / 10);
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${centiseconds.toString().padStart(2, '0')}`;
          };

          const startStopwatch = () => {
            setStartTime(Date.now() - elapsedTime);
            setIsRunning(true);
            setShowSummary(false);
          };

          const resetStopwatch = () => {
            setIsRunning(false);
            setStartTime(null);
            setElapsedTime(0);
            setCompletions({});
            setShowSummary(false);
          };

          const handleTaskComplete = (kid, task) => {
            if (!isRunning) return;
            
            const currentTime = Date.now() - startTime;
            const key = `${kid}-${task}`;
            
            if (completions[key]) return;
            
            const kidCompletions = Object.entries(completions)
              .filter(([k]) => k.startsWith(`${kid}-`))
              .sort((a, b) => b[1].absoluteTime - a[1].absoluteTime);
            
            let lapTime = currentTime;
            if (kidCompletions.length > 0) {
              lapTime = currentTime - kidCompletions[0][1].absoluteTime;
            }
            
            const newCompletions = {
              ...completions,
              [key]: { absoluteTime: currentTime, lapTime }
            };
            
            setCompletions(newCompletions);
            
            const totalTasks = kids.length * tasks.length;
            if (Object.keys(newCompletions).length === totalTasks) {
              setIsRunning(false);
              finishRoutine(newCompletions);
            }
          };

          const finishRoutine = (finalCompletions) => {
            const taskPoints = {};
            tasks.forEach(task => {
              let fastestKid = null;
              let fastestTime = Infinity;
              
              kids.forEach(kid => {
                const key = `${kid}-${task}`;
                if (finalCompletions[key] && finalCompletions[key].lapTime < fastestTime) {
                  fastestTime = finalCompletions[key].lapTime;
                  fastestKid = kid;
                }
              });
              
              if (fastestKid) {
                taskPoints[fastestKid] = (taskPoints[fastestKid] || 0) + 1;
              }
            });

            const newPoints = { ...points };
            Object.keys(taskPoints).forEach(kid => {
              newPoints[kid] = (newPoints[kid] || 0) + taskPoints[kid];
            });
            setPoints(newPoints);

            const record = {
              date: new Date().toISOString(),
              completions: finalCompletions,
              kids: [...kids],
              tasks: [...tasks],
              taskPoints
            };
            setDailyRecords([record, ...dailyRecords]);
            setShowSummary(true);
          };

          const deleteRecord = (index) => {
            const record = dailyRecords[index];
            const newPoints = { ...points };
            Object.entries(record.taskPoints || {}).forEach(([kid, pts]) => {
              newPoints[kid] = (newPoints[kid] || 0) - pts;
            });
            setPoints(newPoints);
            setDailyRecords(dailyRecords.filter((_, i) => i !== index));
          };

          const spendPoints = () => {
            const amount = parseInt(pointsToSpend);
            if (!selectedKid || !amount || amount <= 0 || amount > (points[selectedKid] || 0)) return;
            
            const newPoints = { ...points };
            newPoints[selectedKid] -= amount;
            setPoints(newPoints);
            
            setSelectedKid('');
            setPointsToSpend('');
            setShowSpendPoints(false);
          };

          const addKid = () => {
            if (newKidName.trim()) {
              setKids([...kids, newKidName.trim()]);
              setNewKidName('');
            }
          };

          const addTask = () => {
            if (newTaskName.trim()) {
              setTasks([...tasks, newTaskName.trim()]);
              setNewTaskName('');
            }
          };

          const removeKid = (index) => {
            setKids(kids.filter((_, i) => i !== index));
          };

          const removeTask = (index) => {
            setTasks(tasks.filter((_, i) => i !== index));
          };

          const renameKid = (index, newName) => {
            const newKids = [...kids];
            newKids[index] = newName;
            setKids(newKids);
            setEditingKid(null);
          };

          const renameTask = (index, newName) => {
            const newTasks = [...tasks];
            newTasks[index] = newName;
            setTasks(newTasks);
            setEditingTask(null);
          };

          const getChartData = () => {
            const data = [];
            
            tasks.forEach((task, idx) => {
              const dataPoint = { task: task, taskNum: idx + 1 };
              
              kids.forEach(kid => {
                const key = `${kid}-${task}`;
                if (completions[key]) {
                  dataPoint[kid] = completions[key].absoluteTime / 1000;
                }
              });
              
              data.push(dataPoint);
            });
            
            return data;
          };

          const calculateSummary = () => {
            const kidTimes = {};
            const taskWinners = {};
            const taskPoints = {};
            
            kids.forEach(kid => {
              const kidCompletions = Object.entries(completions)
                .filter(([k]) => k.startsWith(`${kid}-`))
                .sort((a, b) => b[1].absoluteTime - a[1].absoluteTime);
              
              if (kidCompletions.length > 0) {
                kidTimes[kid] = kidCompletions[0][1].absoluteTime;
              }
            });
            
            tasks.forEach(task => {
              let fastestKid = null;
              let fastestTime = Infinity;
              
              kids.forEach(kid => {
                const key = `${kid}-${task}`;
                if (completions[key] && completions[key].lapTime < fastestTime) {
                  fastestTime = completions[key].lapTime;
                  fastestKid = kid;
                }
              });
              
              if (fastestKid) {
                taskWinners[task] = { kid: fastestKid, time: fastestTime };
                taskPoints[fastestKid] = (taskPoints[fastestKid] || 0) + 1;
              }
            });
            
            const overallWinner = Object.entries(kidTimes).reduce((fastest, [kid, time]) => {
              return !fastest || time < fastest.time ? { kid, time } : fastest;
            }, null);
            
            return { kidTimes, taskWinners, overallWinner, taskPoints };
          };

          const summary = showSummary ? calculateSummary() : null;
          const chartData = Object.keys(completions).length > 0 ? getChartData() : [];

          return React.createElement('div', { className: 'min-h-screen bg-gradient-to-br from-indigo-100 via-purple-100 to-pink-100 p-4' },
            React.createElement('div', { className: 'max-w-6xl mx-auto' },
              // Header
              React.createElement('div', { className: 'bg-white rounded-t-3xl shadow-lg p-6' },
                React.createElement('div', { className: 'flex justify-between items-center mb-4' },
                  React.createElement('h1', { className: 'text-3xl font-bold text-indigo-900' }, 'â° Bedtime Tracker'),
                  React.createElement('div', { className: 'flex gap-2' },
                    React.createElement('button', {
                      onClick: () => setShowHistory(!showHistory),
                      className: 'p-3 rounded-full bg-purple-100 text-purple-600 hover:bg-purple-200'
                    }, 'ðŸ“…'),
                    React.createElement('button', {
                      onClick: () => setEditMode(!editMode),
                      className: `p-3 rounded-full ${editMode ? 'bg-indigo-600 text-white' : 'bg-indigo-100 text-indigo-600'}`
                    }, 'âœï¸')
                  )
                ),
                // Stopwatch
                React.createElement('div', { className: 'bg-gradient-to-r from-indigo-500 to-purple-500 rounded-2xl p-6 text-white' },
                  React.createElement('div', { className: 'text-6xl font-mono font-bold text-center mb-4' }, formatTime(elapsedTime)),
                  React.createElement('div', { className: 'flex gap-3 justify-center' },
                    !isRunning && elapsedTime === 0 && React.createElement('button', {
                      onClick: startStopwatch,
                      className: 'bg-white text-indigo-600 px-6 py-3 rounded-full font-semibold hover:bg-indigo-50'
                    }, 'â–¶ï¸ Start Bedtime'),
                    (isRunning || elapsedTime > 0) && React.createElement('button', {
                      onClick: resetStopwatch,
                      className: 'bg-white text-indigo-600 px-6 py-3 rounded-full font-semibold hover:bg-indigo-50'
                    }, 'ðŸ”„ Reset')
                  )
                )
              ),
              
              // Points Display
              React.createElement('div', { className: 'bg-white shadow-lg p-4' },
                React.createElement('div', { className: 'flex justify-between items-center' },
                  React.createElement('h2', { className: 'text-xl font-bold text-indigo-900' }, 'ðŸ† Points Leaderboard'),
                  React.createElement('button', {
                    onClick: () => setShowSpendPoints(!showSpendPoints),
                    className: 'bg-green-500 text-white px-4 py-2 rounded-full font-semibold hover:bg-green-600'
                  }, 'ðŸŽ Spend Points')
                ),
                React.createElement('div', { className: 'grid grid-cols-2 md:grid-cols-4 gap-3 mt-3' },
                  kids.map((kid, idx) =>
                    React.createElement('div', { key: kid, className: 'bg-gradient-to-br from-yellow-400 to-orange-400 rounded-lg p-3 text-white text-center' },
                      React.createElement('div', { className: 'font-bold text-lg' }, kid),
                      React.createElement('div', { className: 'text-3xl font-bold' }, points[kid] || 0),
                      React.createElement('div', { className: 'text-sm opacity-90' }, 'points')
                    )
                  )
                )
              ),
              
              // Spend Points Modal
              showSpendPoints && React.createElement('div', { className: 'bg-white shadow-lg p-4 border-t-2 border-green-500' },
                React.createElement('h3', { className: 'text-lg font-bold text-gray-800 mb-3' }, 'Spend Points on Prize'),
                React.createElement('div', { className: 'space-y-3' },
                  React.createElement('select', {
                    value: selectedKid,
                    onChange: (e) => setSelectedKid(e.target.value),
                    className: 'w-full px-3 py-2 border rounded-lg'
                  },
                    React.createElement('option', { value: '' }, 'Select a kid'),
                    kids.map(kid => React.createElement('option', { key: kid, value: kid }, `${kid} (${points[kid] || 0} points)`))
                  ),
                  React.createElement('input', {
                    type: 'number',
                    value: pointsToSpend,
                    onChange: (e) => setPointsToSpend(e.target.value),
                    className: 'w-full px-3 py-2 border rounded-lg',
                    placeholder: 'Enter points'
                  }),
                  React.createElement('div', { className: 'flex gap-2' },
                    React.createElement('button', {
                      onClick: spendPoints,
                      disabled: !selectedKid || !pointsToSpend || parseInt(pointsToSpend) > (points[selectedKid] || 0),
                      className: 'flex-1 bg-green-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600 disabled:bg-gray-300'
                    }, 'Redeem'),
                    React.createElement('button', {
                      onClick: () => setShowSpendPoints(false),
                      className: 'px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50'
                    }, 'Cancel')
                  )
                )
              ),
              
              // History
              showHistory && React.createElement('div', { className: 'bg-white shadow-lg p-4 border-t-2 border-purple-500 max-h-96 overflow-y-auto' },
                React.createElement('h3', { className: 'text-lg font-bold text-gray-800 mb-3' }, 'Previous Bedtimes'),
                dailyRecords.length === 0 ? 
                  React.createElement('p', { className: 'text-gray-500 text-center py-4' }, 'No previous records') :
                  React.createElement('div', { className: 'space-y-2' },
                    dailyRecords.map((record, idx) =>
                      React.createElement('div', { key: idx, className: 'bg-gray-50 rounded-lg p-3 flex justify-between items-center' },
                        React.createElement('div', null,
                          React.createElement('div', { className: 'font-semibold text-gray-800' },
                            new Date(record.date).toLocaleDateString() + ' ' + new Date(record.date).toLocaleTimeString()
                          ),
                          React.createElement('div', { className: 'text-sm text-gray-600' },
                            'Points: ' + Object.entries(record.taskPoints || {}).map(([kid, pts]) => `${kid}: ${pts}`).join(', ')
                          )
                        ),
                        React.createElement('button', {
                          onClick: () => deleteRecord(idx),
                          className: 'text-red-500 hover:text-red-700 p-2'
                        }, 'ðŸ—‘ï¸')
                      )
                    )
                  )
              ),
              
              // Task Table
              React.createElement('div', { className: 'bg-white shadow-lg overflow-x-auto' },
                React.createElement('table', { className: 'w-full' },
                  React.createElement('thead', null,
                    React.createElement('tr', { className: 'bg-indigo-50' },
                      React.createElement('th', { className: 'p-4 text-left font-bold text-indigo-900 border-r border-indigo-200' }, 'Tasks'),
                      ...kids.map((kid, i) =>
                        React.createElement('th', { key: i, className: 'p-4 text-center font-bold text-indigo-900 border-r border-indigo-200' },
                          editMode && editingKid === i ?
                            React.createElement('input', {
                              type: 'text',
                              defaultValue: kid,
                              autoFocus: true,
                              onBlur: (e) => renameKid(i, e.target.value),
                              onKeyDown: (e) => e.key === 'Enter' && renameKid(i, e.target.value),
                              className: 'w-full px-2 py-1 border rounded text-center'
                            }) :
                            React.createElement('div', { className: 'flex items-center justify-center gap-2' },
                              React.createElement('span', { 
                                onClick: () => editMode && setEditingKid(i),
                                className: 'cursor-pointer'
                              }, kid),
                              editMode && React.createElement('button', {
                                onClick: () => removeKid(i),
                                className: 'text-red-500 hover:text-red-700'
                              }, 'âŒ')
                            )
                        )
                      ),
                      editMode && React.createElement('th', { className: 'p-4' },
                        React.createElement('div', { className: 'flex gap-2' },
                          React.createElement('input', {
                            type: 'text',
                            placeholder: 'New kid',
                            value: newKidName,
                            onChange: (e) => setNewKidName(e.target.value),
                            onKeyDown: (e) => e.key === 'Enter' && addKid(),
                            className: 'px-2 py-1 border rounded text-sm'
                          }),
                          React.createElement('button', {
                            onClick: addKid,
                            className: 'bg-indigo-500 text-white p-1 rounded'
                          }, 'âž•')
                        )
                      )
                    )
                  ),
                  React.createElement('tbody', null,
                    ...tasks.map((task, taskIdx) =>
                      React.createElement('tr', { key: taskIdx, className: 'border-t border-indigo-100' },
                        React.createElement('td', { className: 'p-4 font-semibold text-indigo-900 border-r border-indigo-200' },
                          editMode && editingTask === taskIdx ?
                            React.createElement('input', {
                              type: 'text',
                              defaultValue: task,
                              autoFocus: true,
                              onBlur: (e) => renameTask(taskIdx, e.target.value),
                              onKeyDown: (e) => e.key === 'Enter' && renameTask(taskIdx, e.target.value),
                              className: 'w-full px-2 py-1 border rounded'
                            }) :
                            React.createElement('div', { className: 'flex items-center gap-2' },
                              React.createElement('span', {
                                onClick: () => editMode && setEditingTask(taskIdx),
                                className: 'cursor-pointer'
                              }, task),
                              editMode && React.createElement('button', {
                                onClick: () => removeTask(taskIdx),
                                className: 'text-red-500 hover:text-red-700'
                              }, 'âŒ')
                            )
                        ),
                        ...kids.map((kid, kidIdx) => {
                          const key = `${kid}-${task}`;
                          const completion = completions[key];
                          return React.createElement('td', { key: kidIdx, className: 'p-2 text-center border-r border-indigo-100' },
                            React.createElement('button', {
                              onClick: () => handleTaskComplete(kid, task),
                              disabled: !isRunning || !!completion,
                              className: `w-full py-3 px-2 rounded-lg font-mono text-sm ${
                                completion ? 'bg-green-500 text-white' :
                                isRunning ? 'bg-indigo-100 hover:bg-indigo-200 text-indigo-900' :
                                'bg-gray-100 text-gray-400'
                              }`
                            }, completion ? formatTime(completion.lapTime) : 'â€”')
                          );
                        }),
                        editMode && React.createElement('td', null)
                      )
                    ),
                    editMode && React.createElement('tr', { className: 'border-t border-indigo-200' },
                      React.createElement('td', { className: 'p-4' },
                        React.createElement('div', { className: 'flex gap-2' },
                          React.createElement('input', {
                            type: 'text',
                            placeholder: 'New task',
                            value: newTaskName,
                            onChange: (e) => setNewTaskName(e.target.value),
                            onKeyDown: (e) => e.key === 'Enter' && addTask(),
                            className: 'px-2 py-1 border rounded text-sm flex-1'
                          }),
                          React.createElement('button', {
                            onClick: addTask,
                            className: 'bg-indigo-500 text-white p-1 rounded'
                          }, 'âž•')
                        )
                      )
                    )
                  )
                )
              ),
              
              // Chart
              chartData.length > 0 && React.createElement('div', { className: 'bg-white shadow-lg p-6' },
                React.createElement('h3', { className: 'text-xl font-bold text-indigo-900 mb-4' }, 'Progress Chart'),
                React.createElement(ResponsiveContainer, { width: '100%', height: 300 },
                  React.createElement(LineChart, { data: chartData },
                    React.createElement(CartesianGrid, { strokeDasharray: '3 3' }),
                    React.createElement(XAxis, { dataKey: 'task', angle: -45, textAnchor: 'end', height: 100 }),
                    React.createElement(YAxis, { label: { value: 'Time (seconds)', angle: -90, position: 'insideLeft' } }),
                    React.createElement(Tooltip, null),
                    React.createElement(Legend, null),
                    ...kids.map((kid, idx) =>
                      React.createElement(Line, {
                        key: kid,
                        type: 'monotone',
                        dataKey: kid,
                        stroke: colors[idx % colors.length],
                        strokeWidth: 2,
                        dot: { r: 5 }
                      })
                    )
                  )
                )
              ),
              
              // Summary
              showSummary && summary && React.createElement('div', { className: 'bg-white rounded-b-3xl shadow-lg p-6' },
                React.createElement('div', { className: 'text-center mb-6' },
                  React.createElement('div', { className: 'text-6xl mb-2' }, 'ðŸ†'),
                  React.createElement('h2', { className: 'text-2xl font-bold text-indigo-900' }, 'Bedtime Complete! ðŸŒ™')
                ),
                summary.overallWinner && React.createElement('div', { className: 'bg-gradient-to-r from-yellow-400 to-orange-400 rounded-xl p-4 mb-4 text-center text-white' },
                  React.createElement('div', { className: 'text-lg font-semibold' }, 'Overall Fastest'),
                  React.createElement('div', { className: 'text-3xl font-bold' }, summary.overallWinner.kid),
                  React.createElement('div', { className: 'text-xl' }, formatTime(summary.overallWinner.time))
                ),
                React.createElement('div', { className: 'mb-4' },
                  React.createElement('h3', { className: 'font-bold text-indigo-900 text-lg mb-2' }, 'Points Earned Tonight:'),
                  React.createElement('div', { className: 'grid grid-cols-2 md:grid-cols-4 gap-3' },
                    kids.map(kid =>
                      React.createElement('div', { key: kid, className: 'bg-indigo-50 rounded-lg p-3 text-center' },
                        React.createElement('div', { className: 'font-bold text-indigo-900' }, kid),
                        React.createElement('div', { className: 'text-2xl font-bold text-indigo-600' }, '+' + (summary.taskPoints[kid] || 0))
                      )
                    )
                  )
                ),
                React.createElement('div', { className: 'space-y-3' },
                  React.createElement('h3', { className: 'font-bold text-indigo-900 text-lg' }, 'Task Winners (1 point each):'),
                  ...Object.entries(summary.taskWinners).map(([task, winner]) =>
                    React.createElement('div', { key: task, className: 'bg-indigo-50 rounded-lg p-3 flex justify-between items-center' },
                      React.createElement('span', { className: 'font-semibold text-indigo-900' }, task),
                      React.createElement('div', { className: 'text-right' },
                        React.createElement('div', { className: 'font-bold text-indigo-700' }, winner.kid),
                        React.createElement('div', { className: 'text-sm text-indigo-600' }, formatTime(winner.time))
                      )
                    )
                  )
                )
              )
            )
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(BedtimeTracker));
    </script>
</body>
</html>
