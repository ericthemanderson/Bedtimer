<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bedtime Routine Tracker</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/recharts@2.5.0/dist/Recharts.js"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6366f1">
    <link rel="apple-touch-icon" href="icon-192.png">
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = Recharts;
        
        // Lucide icons as SVG components
        const Clock = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>;
        const Edit3 = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>;
        const Play = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>;
        const RotateCcw = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>;
        const Plus = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
        const X = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;
        const Trophy = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path></svg>;
        const Gift = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 12 20 22 4 22 4 12"></polyline><rect x="2" y="7" width="20" height="5"></rect><line x1="12" y1="22" x2="12" y2="7"></line><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"></path><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"></path></svg>;
        const Trash2 = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>;
        const Calendar = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>;

        function BedtimeTracker() {
          const [isRunning, setIsRunning] = useState(false);
          const [startTime, setStartTime] = useState(null);
          const [elapsedTime, setElapsedTime] = useState(0);
          const [editMode, setEditMode] = useState(false);
          
          const [kids, setKids] = useState(['Emma', 'Liam']);
          const [tasks, setTasks] = useState(['Brush Teeth', 'Pajamas', 'Story Time', 'Lights Out']);
          const [completions, setCompletions] = useState({});
          const [showSummary, setShowSummary] = useState(false);
          
          const [dailyRecords, setDailyRecords] = useState([]);
          const [points, setPoints] = useState({});
          const [showHistory, setShowHistory] = useState(false);
          const [showSpendPoints, setShowSpendPoints] = useState(false);
          const [selectedKid, setSelectedKid] = useState('');
          const [pointsToSpend, setPointsToSpend] = useState('');
          const [prizeDescription, setPrizeDescription] = useState('');
          
          const [newKidName, setNewKidName] = useState('');
          const [newTaskName, setNewTaskName] = useState('');
          const [editingKid, setEditingKid] = useState(null);
          const [editingTask, setEditingTask] = useState(null);

          const colors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899'];

          useEffect(() => {
            let interval;
            if (isRunning) {
              interval = setInterval(() => {
                setElapsedTime(Date.now() - startTime);
              }, 10);
            }
            return () => clearInterval(interval);
          }, [isRunning, startTime]);

          const formatTime = (ms) => {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            const centiseconds = Math.floor((ms % 1000) / 10);
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${centiseconds.toString().padStart(2, '0')}`;
          };

          const startStopwatch = () => {
            setStartTime(Date.now() - elapsedTime);
            setIsRunning(true);
            setShowSummary(false);
          };

          const resetStopwatch = () => {
            setIsRunning(false);
            setStartTime(null);
            setElapsedTime(0);
            setCompletions({});
            setShowSummary(false);
          };

          const handleTaskComplete = (kid, task) => {
            if (!isRunning) return;
            
            const currentTime = Date.now() - startTime;
            const key = `${kid}-${task}`;
            
            if (completions[key]) return;
            
            const kidCompletions = Object.entries(completions)
              .filter(([k]) => k.startsWith(`${kid}-`))
              .sort((a, b) => b[1].absoluteTime - a[1].absoluteTime);
            
            let lapTime = currentTime;
            if (kidCompletions.length > 0) {
              lapTime = currentTime - kidCompletions[0][1].absoluteTime;
            }
            
            const newCompletions = {
              ...completions,
              [key]: { absoluteTime: currentTime, lapTime }
            };
            
            setCompletions(newCompletions);
            
            const totalTasks = kids.length * tasks.length;
            if (Object.keys(newCompletions).length === totalTasks) {
              setIsRunning(false);
              finishRoutine(newCompletions);
            }
          };

          const finishRoutine = (finalCompletions) => {
            const taskPoints = {};
            tasks.forEach(task => {
              let fastestKid = null;
              let fastestTime = Infinity;
              
              kids.forEach(kid => {
                const key = `${kid}-${task}`;
                if (finalCompletions[key] && finalCompletions[key].lapTime < fastestTime) {
                  fastestTime = finalCompletions[key].lapTime;
                  fastestKid = kid;
                }
              });
              
              if (fastestKid) {
                taskPoints[fastestKid] = (taskPoints[fastestKid] || 0) + 1;
              }
            });

            const newPoints = { ...points };
            Object.keys(taskPoints).forEach(kid => {
              newPoints[kid] = (newPoints[kid] || 0) + taskPoints[kid];
            });
            setPoints(newPoints);

            const record = {
              date: new Date().toISOString(),
              completions: finalCompletions,
              kids: [...kids],
              tasks: [...tasks],
              taskPoints
            };
            setDailyRecords([record, ...dailyRecords]);
            setShowSummary(true);
          };

          const deleteRecord = (index) => {
            const record = dailyRecords[index];
            const newPoints = { ...points };
            Object.entries(record.taskPoints || {}).forEach(([kid, pts]) => {
              newPoints[kid] = (newPoints[kid] || 0) - pts;
            });
            setPoints(newPoints);
            setDailyRecords(dailyRecords.filter((_, i) => i !== index));
          };

          const spendPoints = () => {
            const amount = parseInt(pointsToSpend);
            if (!selectedKid || !amount || amount <= 0 || amount > (points[selectedKid] || 0)) return;
            
            const newPoints = { ...points };
            newPoints[selectedKid] -= amount;
            setPoints(newPoints);
            
            setSelectedKid('');
            setPointsToSpend('');
            setPrizeDescription('');
            setShowSpendPoints(false);
          };

          const addKid = () => {
            if (newKidName.trim()) {
              setKids([...kids, newKidName.trim()]);
              setNewKidName('');
            }
          };

          const addTask = () => {
            if (newTaskName.trim()) {
              setTasks([...tasks, newTaskName.trim()]);
              setNewTaskName('');
            }
          };

          const removeKid = (index) => {
            setKids(kids.filter((_, i) => i !== index));
          };

          const removeTask = (index) => {
            setTasks(tasks.filter((_, i) => i !== index));
          };

          const renameKid = (index, newName) => {
            const newKids = [...kids];
            newKids[index] = newName;
            setKids(newKids);
            setEditingKid(null);
          };

          const renameTask = (index, newName) => {
            const newTasks = [...tasks];
            newTasks[index] = newName;
            setTasks(newTasks);
            setEditingTask(null);
          };

          const getChartData = () => {
            const data = [];
            
            tasks.forEach((task, idx) => {
              const dataPoint = { task: task, taskNum: idx + 1 };
              
              kids.forEach(kid => {
                const key = `${kid}-${task}`;
                if (completions[key]) {
                  dataPoint[kid] = completions[key].absoluteTime / 1000;
                }
              });
              
              data.push(dataPoint);
            });
            
            return data;
          };

          const calculateSummary = () => {
            const kidTimes = {};
            const taskWinners = {};
            const taskPoints = {};
            
            kids.forEach(kid => {
              const kidCompletions = Object.entries(completions)
                .filter(([k]) => k.startsWith(`${kid}-`))
                .sort((a, b) => b[1].absoluteTime - a[1].absoluteTime);
              
              if (kidCompletions.length > 0) {
                kidTimes[kid] = kidCompletions[0][1].absoluteTime;
              }
            });
            
            tasks.forEach(task => {
              let fastestKid = null;
              let fastestTime = Infinity;
              
              kids.forEach(kid => {
                const key = `${kid}-${task}`;
                if (completions[key] && completions[key].lapTime < fastestTime) {
                  fastestTime = completions[key].lapTime;
                  fastestKid = kid;
                }
              });
              
              if (fastestKid) {
                taskWinners[task] = { kid: fastestKid, time: fastestTime };
                taskPoints[fastestKid] = (taskPoints[fastestKid] || 0) + 1;
              }
            });
            
            const overallWinner = Object.entries(kidTimes).reduce((fastest, [kid, time]) => {
              return !fastest || time < fastest.time ? { kid, time } : fastest;
            }, null);
            
            return { kidTimes, taskWinners, overallWinner, taskPoints };
          };

          const summary = showSummary ? calculateSummary() : null;
          const chartData = Object.keys(completions).length > 0 ? getChartData() : [];

          return (
            <div className="min-h-screen bg-gradient-to-br from-indigo-100 via-purple-100 to-pink-100 p-4">
              <div className="max-w-6xl mx-auto">
                <div className="bg-white rounded-t-3xl shadow-lg p-6">
                  <div className="flex justify-between items-center mb-4">
                    <h1 className="text-3xl font-bold text-indigo-900 flex items-center gap-2">
                      <Clock />
                      Bedtime Tracker
                    </h1>
                    <div className="flex gap-2">
                      <button
                        onClick={() => setShowHistory(!showHistory)}
                        className="p-3 rounded-full bg-purple-100 text-purple-600 hover:bg-purple-200 transition-colors"
                      >
                        <Calendar />
                      </button>
                      <button
                        onClick={() => setEditMode(!editMode)}
                        className={`p-3 rounded-full transition-colors ${
                          editMode ? 'bg-indigo-600 text-white' : 'bg-indigo-100 text-indigo-600'
                        }`}
                      >
                        <Edit3 />
                      </button>
                    </div>
                  </div>
                  
                  <div className="bg-gradient-to-r from-indigo-500 to-purple-500 rounded-2xl p-6 text-white">
                    <div className="text-6xl font-mono font-bold text-center mb-4">
                      {formatTime(elapsedTime)}
                    </div>
                    <div className="flex gap-3 justify-center">
                      {!isRunning && elapsedTime === 0 && (
                        <button
                          onClick={startStopwatch}
                          className="bg-white text-indigo-600 px-6 py-3 rounded-full font-semibold flex items-center gap-2 hover:bg-indigo-50 transition-colors"
                        >
                          <Play />
                          Start Bedtime
                        </button>
                      )}
                      {(isRunning || elapsedTime > 0) && (
                        <button
                          onClick={resetStopwatch}
                          className="bg-white text-indigo-600 px-6 py-3 rounded-full font-semibold flex items-center gap-2 hover:bg-indigo-50 transition-colors"
                        >
                          <RotateCcw />
                          Reset
                        </button>
                      )}
                    </div>
                  </div>
                </div>

                <div className="bg-white shadow-lg p-4">
                  <div className="flex justify-between items-center">
                    <h2 className="text-xl font-bold text-indigo-900 flex items-center gap-2">
                      <Trophy />
                      Points Leaderboard
                    </h2>
                    <button
                      onClick={() => setShowSpendPoints(!showSpendPoints)}
                      className="bg-green-500 text-white px-4 py-2 rounded-full font-semibold flex items-center gap-2 hover:bg-green-600 transition-colors"
                    >
                      <Gift />
                      Spend Points
                    </button>
                  </div>
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3">
                    {kids.map((kid, idx) => (
                      <div key={kid} className="bg-gradient-to-br from-yellow-400 to-orange-400 rounded-lg p-3 text-white text-center">
                        <div className="font-bold text-lg">{kid}</div>
                        <div className="text-3xl font-bold">{points[kid] || 0}</div>
                        <div className="text-sm opacity-90">points</div>
                      </div>
                    ))}
                  </div>
                </div>

                {showSpendPoints && (
                  <div className="bg-white shadow-lg p-4 border-t-2 border-green-500">
                    <h3 className="text-lg font-bold text-gray-800 mb-3">Spend Points on Prize</h3>
                    <div className="space-y-3">
                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-1">Kid</label>
                        <select 
                          value={selectedKid} 
                          onChange={(e) => setSelectedKid(e.target.value)}
                          className="w-full px-3 py-2 border rounded-lg"
                        >
                          <option value="">Select a kid</option>
                          {kids.map(kid => (
                            <option key={kid} value={kid}>{kid} ({points[kid] || 0} points)</option>
                          ))}
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-1">Points to Spend</label>
                        <input
                          type="number"
                          value={pointsToSpend}
                          onChange={(e) => setPointsToSpend(e.target.value)}
                          className="w-full px-3 py-2 border rounded-lg"
                          placeholder="Enter points"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-1">Prize (optional)</label>
                        <input
                          type="text"
                          value={prizeDescription}
                          onChange={(e) => setPrizeDescription(e.target.value)}
                          className="w-full px-3 py-2 border rounded-lg"
                          placeholder="e.g., Extra story, Stay up 15 min later"
                        />
                      </div>
                      <div className="flex gap-2">
                        <button
                          onClick={spendPoints}
                          disabled={!selectedKid || !pointsToSpend || parseInt(pointsToSpend) > (points[selectedKid] || 0)}
                          className="flex-1 bg-green-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed"
                        >
                          Redeem
                        </button>
                        <button
                          onClick={() => setShowSpendPoints(false